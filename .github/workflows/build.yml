name: Build

# åªèƒ½æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒæ‰€æœ‰åˆ†æ”¯
on:
  workflow_dispatch:
    inputs:
      build_target:
        description: 'é€‰æ‹©æž„å»ºç›®æ ‡'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - server
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

# æƒé™è®¾ç½®
permissions:
  contents: read
  actions: write

jobs:
  # å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_time: ${{ steps.time.outputs.build_time }}
      branch_name: ${{ steps.branch.outputs.branch_name }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      version_web: ${{ steps.version.outputs.version_web }}
      version_server: ${{ steps.version.outputs.version_server }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable
          yarn --version

      - name: Get build time
        id: time
        run: echo "build_time=$(date '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Get branch name
        id: branch
        run: echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Get commit SHA
        id: commit
        run: echo "commit_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      - name: Generate versions
        id: version
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date '+%Y%m%d-%H%M%S')
          echo "version_web=${BRANCH_NAME}-${BUILD_TIME}-web" >> $GITHUB_OUTPUT
          echo "version_server=${BRANCH_NAME}-${BUILD_TIME}-server" >> $GITHUB_OUTPUT

  # Webç«¯æž„å»º
  build-web:
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'web' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable

      - name: Install dependencies (Workspace)
        run: |
          yarn install --immutable
          yarn workspaces list

      - name: Install Lerna globally
        run: npm install -g lerna@^8.2.3

      - name: Build web (Lerna)
        run: lerna run build --scope=web

      - name: Create web build info
        run: |
          mkdir -p web/dist
          cat > web/dist/build-info.txt << EOF
          Webç«¯æž„å»ºä¿¡æ¯
          =============
          ç‰ˆæœ¬å·: ${{ needs.prepare.outputs.version_web }}
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          åˆ†æ”¯: ${{ needs.prepare.outputs.branch_name }}
          æäº¤: ${{ needs.prepare.outputs.commit_sha }}
          æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}
          è§¦å‘è€…: ${{ github.actor }}
          
          æž„å»ºäº§ç‰©:
          - Web é™æ€æ–‡ä»¶: dist/
          - Docker é…ç½®: Dockerfile
          
          æž„å»ºçŠ¶æ€: æˆåŠŸ
          EOF

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: |
            web/dist/
            web/Dockerfile
          retention-days: 30


  # æœåŠ¡ç«¯æž„å»º
  build-server:
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'server' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable

      - name: Install dependencies (Workspace)
        run: |
          yarn install --immutable
          yarn workspaces list

      - name: Install Lerna globally
        run: npm install -g lerna@^8.2.3

      - name: Build server (Lerna)
        run: lerna run build --scope=server

      - name: Create server build info
        run: |
          mkdir -p server/dist
          cat > server/dist/build-info.txt << EOF
          æœåŠ¡ç«¯æž„å»ºä¿¡æ¯
          ===============
          ç‰ˆæœ¬å·: ${{ needs.prepare.outputs.version_server }}
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          åˆ†æ”¯: ${{ needs.prepare.outputs.branch_name }}
          æäº¤: ${{ needs.prepare.outputs.commit_sha }}
          æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}
          è§¦å‘è€…: ${{ github.actor }}
          
          æž„å»ºäº§ç‰©:
          - æœåŠ¡ç«¯ä»£ç : dist/
          - ç”Ÿäº§ä¾èµ–: package.json
          - Docker é…ç½®: Dockerfile
          
          éƒ¨ç½²è¯´æ˜Ž:
          1. ä½¿ç”¨ docker-compose up -d å¯åŠ¨æœåŠ¡
          2. éªŒè¯æœåŠ¡: curl http://localhost:10000/health
          
          æž„å»ºçŠ¶æ€: æˆåŠŸ
          EOF

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: |
            server/dist/
            server/package.json
            server/Dockerfile
          retention-days: 30

  # åˆ›å»ºéƒ¨ç½²åŒ…
  create-deployment-package:
    runs-on: ubuntu-latest
    needs: [prepare, build-web, build-server]
    if: ${{ github.event.inputs.build_target == 'all' && needs.build-web.result == 'success' && needs.build-server.result == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web/

      - name: Download server artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-build
          path: server/

      - name: Create deployment package structure
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…ç›®å½•ç»“æž„
          mkdir -p deployment-package
          
          # å¤åˆ¶ docker-compose.yml åˆ°æ ¹ç›®å½•
          cp docker-compose.yml deployment-package/
          
          # åˆ›å»º web ç›®å½•ç»“æž„
          mkdir -p deployment-package/web
          cp -r web/dist deployment-package/web/
          cp web/Dockerfile deployment-package/web/
          
          # åˆ›å»º server ç›®å½•ç»“æž„
          mkdir -p deployment-package/server
          cp -r server/dist deployment-package/server/
          cp server/package.json deployment-package/server/
          cp server/Dockerfile deployment-package/server/
          
          # å¤åˆ¶ nginx é…ç½®
          cp -r nginx deployment-package/
          
          # å¤åˆ¶ mysql åˆå§‹åŒ–è„šæœ¬
          if [ -d "mysql" ]; then
            cp -r mysql deployment-package/
          fi
          
          # åˆ›å»ºéƒ¨ç½²è¯´æ˜Žæ–‡ä»¶
          cat > deployment-package/README.md << EOF
          # Seek-Self éƒ¨ç½²åŒ…
          
          ## æž„å»ºä¿¡æ¯
          - ç‰ˆæœ¬: ${{ needs.prepare.outputs.branch_name }}-${{ needs.prepare.outputs.build_time }}
          - æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - åˆ†æ”¯: ${{ needs.prepare.outputs.branch_name }}
          - æäº¤: ${{ needs.prepare.outputs.commit_sha }}
          - æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}
          
          ## ç›®å½•ç»“æž„
          \`\`\`
          deployment-package/
          â”œâ”€â”€ docker-compose.yml          # Docker Compose é…ç½®æ–‡ä»¶
          â”œâ”€â”€ web/                        # Web å‰ç«¯
          â”‚   â”œâ”€â”€ build-info.txt         # æž„å»ºä¿¡æ¯
          â”‚   â”œâ”€â”€ dist/                  # æž„å»ºäº§ç‰©
          â”‚   â””â”€â”€ Dockerfile             # Docker é…ç½®
          â”œâ”€â”€ server/                     # åŽç«¯æœåŠ¡
          â”‚   â”œâ”€â”€ build-info.txt         # æž„å»ºä¿¡æ¯
          â”‚   â”œâ”€â”€ dist/                  # æž„å»ºäº§ç‰©
          â”‚   â”œâ”€â”€ package.json           # ä¾èµ–é…ç½®
          â”‚   â””â”€â”€ Dockerfile             # Docker é…ç½®
          â”œâ”€â”€ nginx/                      # Nginx é…ç½®
          â”‚   â”œâ”€â”€ nginx.conf
          â”‚   â””â”€â”€ conf.d/
          â””â”€â”€ mysql/                      # MySQL åˆå§‹åŒ–è„šæœ¬
              â””â”€â”€ init/
          \`\`\`
          
          ## å¿«é€Ÿéƒ¨ç½²
          1. è§£åŽ‹éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
          2. è¿›å…¥éƒ¨ç½²åŒ…ç›®å½•: \`cd deployment-package\`
          3. å¯åŠ¨æœåŠ¡: \`docker-compose up -d\`
          4. è®¿é—®åº”ç”¨: http://localhost:10000
          
          ## æœåŠ¡ç«¯å£
          - Web æœåŠ¡: http://localhost:10000
          - MySQL: localhost:3306
          - PeerJS: localhost:3478
          
          ## åœæ­¢æœåŠ¡
          \`\`\`bash
          docker-compose down
          \`\`\`
          
          ## æŸ¥çœ‹æ—¥å¿—
          \`\`\`bash
          docker-compose logs -f
          \`\`\`
          EOF

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: seek-self-deployment-${{ needs.prepare.outputs.branch_name }}-${{ needs.prepare.outputs.build_time }}
          path: deployment-package/
          retention-days: 30

  # æž„å»ºæ€»ç»“
  build-summary:
    runs-on: ubuntu-latest
    needs: [prepare, build-web, build-server, create-deployment-package]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºæ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ needs.prepare.outputs.branch_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æäº¤ | ${{ needs.prepare.outputs.commit_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç›®æ ‡ | ${{ github.event.inputs.build_target }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | ${{ github.event.inputs.build_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘è€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "| ç»„ä»¶ | ç‰ˆæœ¬å· | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.prepare.outputs.version_web }} | ${{ needs.build-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.prepare.outputs.version_server }} | ${{ needs.build-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²åŒ… | ${{ needs.prepare.outputs.branch_name }}-${{ needs.prepare.outputs.build_time }} | ${{ needs.create-deployment-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ äº§ç‰©ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºå®ŒæˆåŽï¼Œå¯åœ¨ Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†ä¸‹è½½ä»¥ä¸‹äº§ç‰©ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.create-deployment-package.result }}" == "success" ]; then
            echo "ðŸŽ¯ **æŽ¨èä¸‹è½½**: \`seek-self-deployment-${{ needs.prepare.outputs.branch_name }}-${{ needs.prepare.outputs.build_time }}\` - å®Œæ•´éƒ¨ç½²åŒ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**éƒ¨ç½²æ­¥éª¤**:" >> $GITHUB_STEP_SUMMARY
            echo "1. ä¸‹è½½éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
            echo "2. \`docker-compose up -d\`" >> $GITHUB_STEP_SUMMARY
            echo "3. è®¿é—® http://localhost:10000" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ç›®å½•ç»“æž„**:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "deployment-package/" >> $GITHUB_STEP_SUMMARY
            echo "â”œâ”€â”€ docker-compose.yml" >> $GITHUB_STEP_SUMMARY
            echo "â”œâ”€â”€ web/dist/ + Dockerfile" >> $GITHUB_STEP_SUMMARY
            echo "â”œâ”€â”€ server/dist/ + package.json + Dockerfile" >> $GITHUB_STEP_SUMMARY
            echo "â”œâ”€â”€ nginx/" >> $GITHUB_STEP_SUMMARY
            echo "â””â”€â”€ mysql/" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- \`web-build\` - Web å‰ç«¯æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
            echo "- \`server-build\` - æœåŠ¡ç«¯æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          fi
