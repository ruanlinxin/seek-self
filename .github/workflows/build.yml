name: Build

# åªèƒ½æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒæ‰€æœ‰åˆ†æ”¯
on:
  workflow_dispatch:
    inputs:
      build_target:
        description: 'é€‰æ‹©æž„å»ºç›®æ ‡'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - mobile
          - server
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

# æƒé™è®¾ç½®
permissions:
  contents: read
  actions: write

jobs:
  # å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_time: ${{ steps.time.outputs.build_time }}
      branch_name: ${{ steps.branch.outputs.branch_name }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      version_web: ${{ steps.version.outputs.version_web }}
      version_mobile: ${{ steps.version.outputs.version_mobile }}
      version_server: ${{ steps.version.outputs.version_server }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable
          yarn --version

      - name: Get build time
        id: time
        run: echo "build_time=$(date '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Get branch name
        id: branch
        run: echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Get commit SHA
        id: commit
        run: echo "commit_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      - name: Generate versions
        id: version
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date '+%Y%m%d-%H%M%S')
          echo "version_web=${BRANCH_NAME}-${BUILD_TIME}-web" >> $GITHUB_OUTPUT
          echo "version_mobile=${BRANCH_NAME}-${BUILD_TIME}-mobile" >> $GITHUB_OUTPUT
          echo "version_server=${BRANCH_NAME}-${BUILD_TIME}-server" >> $GITHUB_OUTPUT

  # Webç«¯æž„å»º
  build-web:
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'web' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable

      - name: Install dependencies (Workspace)
        run: |
          yarn install --immutable
          yarn workspaces list

      - name: Install Lerna globally
        run: npm install -g lerna@^8.2.3

      - name: Build web (Lerna)
        run: lerna run build --scope=web

      - name: Create web build package
        run: |
          cd ${{ github.workspace }}
          mkdir -p dist/web
          
          # å¤åˆ¶æž„å»ºäº§ç‰©
          cp -r web/dist dist/web/
          cp web/Dockerfile dist/web/
          cp web/nginx.conf dist/web/
          cp docker-compose.yml dist/
          cp -r nginx dist/
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯
          cat > dist/web/build-info.txt << EOF
          Webç«¯æž„å»ºä¿¡æ¯
          =============
          ç‰ˆæœ¬å·: ${{ needs.prepare.outputs.version_web }}
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          åˆ†æ”¯: ${{ needs.prepare.outputs.branch_name }}
          æäº¤: ${{ needs.prepare.outputs.commit_sha }}
          æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}
          è§¦å‘è€…: ${{ github.actor }}
          
          æž„å»ºäº§ç‰©:
          - Web é™æ€æ–‡ä»¶: dist/
          - Docker é…ç½®: Dockerfile, nginx.conf
          - æœåŠ¡é…ç½®: docker-compose.yml, nginx/
          
          æž„å»ºçŠ¶æ€: æˆåŠŸ
          EOF

      - name: Create web archive
        run: |
          cd dist
          tar -czf web-${{ needs.prepare.outputs.version_web }}.tar.gz web/ docker-compose.yml nginx/

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-${{ needs.prepare.outputs.version_web }}
          path: |
            dist/web-${{ needs.prepare.outputs.version_web }}.tar.gz
            dist/web/build-info.txt
          retention-days: 30

  # ç§»åŠ¨ç«¯æž„å»º
  build-mobile:
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'mobile' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          build-tools: 33.0.0
          ndk-version: 25.1.8937393

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable

      - name: Install dependencies (Workspace)
        run: |
          yarn install --immutable
          yarn workspaces list

      - name: Prebuild Android (Workspace)
        run: |
          if [ ! -d "mobile/android" ]; then
            echo "æ‰§è¡Œé¢„æž„å»º..."
            yarn workspace mobile expo prebuild --platform android --clean
          else
            echo "Android é¡¹ç›®å·²å­˜åœ¨ï¼Œè·³è¿‡é¢„æž„å»º"
          fi

      - name: Create local.properties
        run: |
          cd mobile/android
          echo "sdk.dir=$ANDROID_HOME" > local.properties

      - name: Build Android APK
        run: |
          cd mobile/android
          chmod +x gradlew
          ./gradlew clean
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            ./gradlew assembleRelease
          else
            ./gradlew assembleDebug
          fi

      - name: Create mobile build package
        run: |
          mkdir -p dist/mobile
          
          # å¤åˆ¶ APK æ–‡ä»¶
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            cp mobile/android/app/build/outputs/apk/release/app-release.apk dist/mobile/${{ needs.prepare.outputs.version_mobile }}.apk
          else
            cp mobile/android/app/build/outputs/apk/debug/app-debug.apk dist/mobile/${{ needs.prepare.outputs.version_mobile }}.apk
          fi
          
          # èŽ·å– APK ä¿¡æ¯
          APK_SIZE=$(du -h dist/mobile/${{ needs.prepare.outputs.version_mobile }}.apk | cut -f1)
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯
          cat > dist/mobile/build-info.txt << EOF
          ç§»åŠ¨ç«¯æž„å»ºä¿¡æ¯
          ===============
          ç‰ˆæœ¬å·: ${{ needs.prepare.outputs.version_mobile }}
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          åˆ†æ”¯: ${{ needs.prepare.outputs.branch_name }}
          æäº¤: ${{ needs.prepare.outputs.commit_sha }}
          æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}
          è§¦å‘è€…: ${{ github.actor }}
          
          æž„å»ºäº§ç‰©:
          - APK æ–‡ä»¶: ${{ needs.prepare.outputs.version_mobile }}.apk
          - æ–‡ä»¶å¤§å°: ${APK_SIZE}
          
          å®‰è£…è¯´æ˜Ž:
          1. ä¸‹è½½ APK æ–‡ä»¶åˆ° Android è®¾å¤‡
          2. å¼€å¯"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…æƒé™
          3. ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…
          
          æž„å»ºçŠ¶æ€: æˆåŠŸ
          EOF

      - name: Upload mobile artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-${{ needs.prepare.outputs.version_mobile }}
          path: dist/mobile/
          retention-days: 30

  # æœåŠ¡ç«¯æž„å»º
  build-server:
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'server' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          corepack: true

      - name: Enable Yarn Modern
        run: |
          corepack enable
          yarn set version stable

      - name: Install dependencies (Workspace)
        run: |
          yarn install --immutable
          yarn workspaces list

      - name: Install Lerna globally
        run: npm install -g lerna@^8.2.3

      - name: Build server (Lerna)
        run: lerna run build --scope=server

      - name: Create server build package
        run: |
          cd ${{ github.workspace }}
          mkdir -p dist/server
          
          # å¤åˆ¶æž„å»ºäº§ç‰©
          cp -r server/dist dist/server/
          cp server/package.json dist/server/
          if [ -f "server/Dockerfile" ]; then
            cp server/Dockerfile dist/server/
          fi
          if [ -f "server/.env.example" ]; then
            cp server/.env.example dist/server/
          fi
          cp docker-compose.yml dist/
          cp -r nginx dist/
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯
          cat > dist/server/build-info.txt << EOF
          æœåŠ¡ç«¯æž„å»ºä¿¡æ¯
          ===============
          ç‰ˆæœ¬å·: ${{ needs.prepare.outputs.version_server }}
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          åˆ†æ”¯: ${{ needs.prepare.outputs.branch_name }}
          æäº¤: ${{ needs.prepare.outputs.commit_sha }}
          æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}
          è§¦å‘è€…: ${{ github.actor }}
          
          æž„å»ºäº§ç‰©:
          - æœåŠ¡ç«¯ä»£ç : dist/
          - ç”Ÿäº§ä¾èµ–: package.json
          - Docker é…ç½®: Dockerfile (å¦‚æžœå­˜åœ¨)
          - çŽ¯å¢ƒé…ç½®: .env.example (å¦‚æžœå­˜åœ¨)
          - æœåŠ¡é…ç½®: docker-compose.yml, nginx/
          
          éƒ¨ç½²è¯´æ˜Ž:
          1. å®‰è£…ç”Ÿäº§ä¾èµ–: npm install --production
          2. è®¾ç½®çŽ¯å¢ƒå˜é‡: å¤åˆ¶ .env.example ä¸º .env å¹¶é…ç½®
          3. å¯åŠ¨æœåŠ¡: npm start æˆ– docker-compose up -d
          4. éªŒè¯æœåŠ¡: curl http://localhost:3000/health
          
          æž„å»ºçŠ¶æ€: æˆåŠŸ
          EOF

      - name: Create server archive
        run: |
          cd dist
          tar -czf server-${{ needs.prepare.outputs.version_server }}.tar.gz server/ docker-compose.yml nginx/

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ needs.prepare.outputs.version_server }}
          path: |
            dist/server-${{ needs.prepare.outputs.version_server }}.tar.gz
            dist/server/build-info.txt
          retention-days: 30

  # æž„å»ºæ€»ç»“
  build-summary:
    runs-on: ubuntu-latest
    needs: [prepare, build-web, build-mobile, build-server]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸš€ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºæ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ needs.prepare.outputs.branch_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æäº¤ | ${{ needs.prepare.outputs.commit_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç›®æ ‡ | ${{ github.event.inputs.build_target }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | ${{ github.event.inputs.build_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘è€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| ç«¯ | ç‰ˆæœ¬å· | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.prepare.outputs.version_web }} | ${{ needs.build-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile | ${{ needs.prepare.outputs.version_mobile }} | ${{ needs.build-mobile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.prepare.outputs.version_server }} | ${{ needs.build-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºå®ŒæˆåŽï¼Œå¯åœ¨ Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†ä¸‹è½½å¯¹åº”çš„æž„å»ºäº§ç‰©ã€‚" >> $GITHUB_STEP_SUMMARY
