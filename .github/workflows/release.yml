name: Release

# æ‰‹åŠ¨è§¦å‘å‘å¸ƒæµæ°´çº¿
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      build_run_id:
        description: 'æž„å»ºæµæ°´çº¿çš„ Run ID (å¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨æœ€æ–°çš„æž„å»º)'
        required: false
        type: string

# æƒé™è®¾ç½®
permissions:
  contents: write
  actions: read

jobs:
  # åˆ›å»ºå‘å¸ƒ
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest build run
        id: get_build
        run: |
          if [ -n "${{ github.event.inputs.build_run_id }}" ]; then
            echo "build_run_id=${{ github.event.inputs.build_run_id }}" >> $GITHUB_OUTPUT
          else
            # èŽ·å–æœ€æ–°çš„æˆåŠŸæž„å»º
            LATEST_RUN=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/actions/workflows/build.yml/runs?status=success&per_page=1" \
              --jq '.workflow_runs[0].id')
            echo "build_run_id=$LATEST_RUN" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version }}
          release_name: Seek-Self ${{ github.event.inputs.version }}
          body: |
            ## ðŸš€ Seek-Self ${{ github.event.inputs.version }}
            
            ### ðŸ“¦ éƒ¨ç½²åŒ…ä¸‹è½½
            
            ä¸‹è½½ `seek-self.zip` éƒ¨ç½²åŒ…ï¼Œè§£åŽ‹åŽç›´æŽ¥ä½¿ç”¨ `docker-compose up -d` å³å¯å¿«é€Ÿéƒ¨ç½²ã€‚
            
            ### ðŸ› ï¸ éƒ¨ç½²æ­¥éª¤
            
            1. ä¸‹è½½å¹¶è§£åŽ‹ `seek-self.zip`
            2. è¿›å…¥è§£åŽ‹åŽçš„ç›®å½•
            3. è¿è¡Œ `docker-compose up -d`
            4. è®¿é—® http://localhost:10000
            
            ### ðŸ“‹ æœåŠ¡ç«¯å£
            
            - **Web æœåŠ¡**: http://localhost:10000
            - **MySQL**: localhost:3306
            - **PeerJS**: localhost:3478
            
            ### ðŸ”§ ç®¡ç†å‘½ä»¤
            
            ```bash
            # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
            docker-compose ps
            
            # æŸ¥çœ‹æ—¥å¿—
            docker-compose logs -f
            
            # åœæ­¢æœåŠ¡
            docker-compose down
            
            # æ•°æ®å¤‡ä»½
            docker exec seek-self-mysql mysqldump -u root -proot123456 seek_self > backup.sql
            ```
            
            ### ðŸ“ æ›´æ–°æ—¥å¿—
            
            - åŸºäºŽæž„å»º ID: ${{ steps.get_build.outputs.build_run_id }}
            - å‘å¸ƒæ—¶é—´: ${{ github.run_number }}
            
            ---
            
            æž„å»ºæ¥æº: [Actions Run #${{ steps.get_build.outputs.build_run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.get_build.outputs.build_run_id }})
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}

  # ä¸‹è½½æž„å»ºäº§ç‰©å¹¶ä¸Šä¼ åˆ° Release
  upload-assets:
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get build run ID
        id: get_build
        run: |
          if [ -n "${{ github.event.inputs.build_run_id }}" ]; then
            echo "build_run_id=${{ github.event.inputs.build_run_id }}" >> $GITHUB_OUTPUT
          else
            # èŽ·å–æœ€æ–°çš„æˆåŠŸæž„å»º
            LATEST_RUN=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/actions/workflows/build.yml/runs?status=success&per_page=1" \
              --jq '.workflow_runs[0].id')
            echo "build_run_id=$LATEST_RUN" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifacts
        run: |
          # ä¸‹è½½æŒ‡å®šæž„å»ºçš„ seek-self äº§ç‰©
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${{ steps.get_build.outputs.build_run_id }}/artifacts" \
            --jq '.artifacts[] | select(.name == "seek-self") | .archive_download_url' > artifact_url.txt
          
          if [ -s artifact_url.txt ]; then
            ARTIFACT_URL=$(cat artifact_url.txt)
            echo "Downloading artifact from: $ARTIFACT_URL"
            
            # ä¸‹è½½ artifact
            gh api "$ARTIFACT_URL" > seek-self-artifact.zip
            
            # è§£åŽ‹ artifact
            unzip seek-self-artifact.zip
            
            # é‡æ–°æ‰“åŒ…ä¸ºå‘å¸ƒåŒ…
            cd deployment-package
            zip -r ../seek-self.zip .
            cd ..
            
            echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ: seek-self.zip"
            ls -la seek-self.zip
          else
            echo "âŒ æœªæ‰¾åˆ° seek-self æž„å»ºäº§ç‰©"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./seek-self.zip
          asset_name: seek-self.zip
          asset_content_type: application/zip

  # å‘å¸ƒæ€»ç»“
  release-summary:
    runs-on: ubuntu-latest
    needs: [create-release, upload-assets]
    if: always()
    steps:
      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ å‘å¸ƒå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å· | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å‘å¸ƒæ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| é¢„å‘å¸ƒ | ${{ github.event.inputs.prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘è€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [å‘å¸ƒé¡µé¢](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ å¿«é€Ÿéƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ \`seek-self.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "2. è§£åŽ‹åˆ°æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
          echo "3. è¿è¡Œ \`docker-compose up -d\`" >> $GITHUB_STEP_SUMMARY
          echo "4. è®¿é—® http://localhost:10000" >> $GITHUB_STEP_SUMMARY
